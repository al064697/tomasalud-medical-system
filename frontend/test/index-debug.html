<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - TomaSalud</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-section h2 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        .log-output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .api-test {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .test-result {
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            font-family: monospace;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .form-group {
            margin: 10px 0;
        }
        label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üîß TomaSalud - Panel de Debug</h1>

    <!-- Secci√≥n de Estado de Conexi√≥n -->
    <div class="debug-section">
        <h2>üåê Estado de Conexi√≥n</h2>
        <div class="button-group">
            <button onclick="testBackendConnection()">Probar Backend</button>
            <button onclick="testFrontendConnection()">Probar Frontend</button>
            <button onclick="testAllEndpoints()">Probar Todos los Endpoints</button>
        </div>
        <div id="connection-status"></div>
    </div>

    <!-- Secci√≥n de Autenticaci√≥n -->
    <div class="debug-section">
        <h2>üîê Debug de Autenticaci√≥n</h2>
        <div class="form-group">
            <label>Email:</label>
            <input type="email" id="login-email" value="freligio008@gmail.com">
        </div>
        <div class="form-group">
            <label>Password:</label>
            <input type="password" id="login-password" value="123456">
        </div>
        <div class="button-group">
            <button onclick="debugLogin()">Login</button>
            <button onclick="checkStoredAuth()">Verificar localStorage</button>
            <button onclick="clearLocalStorage()" class="danger">Limpiar localStorage</button>
        </div>
        <div id="auth-status"></div>
    </div>

    <!-- Secci√≥n de Medicamentos -->
    <div class="debug-section">
        <h2>üíä Debug de Medicamentos</h2>
        <div class="form-group">
            <label>Usuario ID:</label>
            <input type="number" id="user-id" value="1">
        </div>
        <div class="button-group">
            <button onclick="testMedicamentosAPI()">Probar API Medicamentos</button>
            <button onclick="debugMedicamentosFrontend()">Debug Frontend</button>
            <button onclick="createTestMedicamento()">Crear Medicamento de Prueba</button>
        </div>
        <div id="medicamentos-status"></div>
    </div>

    <!-- Secci√≥n de Tratamientos -->
    <div class="debug-section">
        <h2>üè• Debug de Tratamientos</h2>
        <div class="button-group">
            <button onclick="testTratamientosAPI()">Probar API Tratamientos</button>
            <button onclick="createTestTratamiento()">Crear Tratamiento de Prueba</button>
        </div>
        <div id="tratamientos-status"></div>
    </div>

    <!-- Secci√≥n de Base de Datos -->
    <div class="debug-section">
        <h2>üóÑÔ∏è Debug de Base de Datos</h2>
        <div class="button-group">
            <button onclick="checkDatabaseTables()">Verificar Tablas</button>
            <button onclick="showDatabaseData()">Mostrar Datos</button>
        </div>
        <div id="database-status"></div>
    </div>

    <!-- Console Log Output -->
    <div class="debug-section">
        <h2>üìã Log de Console</h2>
        <div class="button-group">
            <button onclick="clearLogs()">Limpiar Logs</button>
            <button onclick="enableVerboseLogging()">Logging Detallado</button>
        </div>
        <div id="console-output" class="log-output"></div>
    </div>

    <script>
        // Configuraci√≥n base
        const BASE_URL = 'http://127.0.0.1:8000';
        let currentUserId = null;
        let verboseLogging = false;

        // Funci√≥n para agregar logs a la interfaz
        function addLog(message, type = 'info') {
            const logOutput = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logOutput.textContent += logEntry;
            logOutput.scrollTop = logOutput.scrollHeight;
            
            // Tambi√©n log a la consola del navegador
            if (type === 'error') {
                console.error(message);
            } else {
                console.log(message);
            }
        }

        // Funci√≥n para mostrar estado
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
            addLog(`${elementId}: ${message}`, type);
        }

        // Test de conexi√≥n del backend
        async function testBackendConnection() {
            try {
                addLog('üîç Probando conexi√≥n del backend...');
                const response = await fetch(`${BASE_URL}/usuarios/`);
                const data = await response.json();
                
                if (response.ok) {
                    showStatus('connection-status', `‚úÖ Backend OK - ${data.length} usuarios encontrados`, 'success');
                } else {
                    showStatus('connection-status', `‚ùå Backend Error: ${response.status}`, 'error');
                }
            } catch (error) {
                showStatus('connection-status', `‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        // Test de conexi√≥n del frontend
        async function testFrontendConnection() {
            try {
                addLog('üîç Probando conexi√≥n del frontend...');
                const response = await fetch('/index.html');
                
                if (response.ok) {
                    showStatus('connection-status', '‚úÖ Frontend OK - Servidor HTTP funcionando', 'success');
                } else {
                    showStatus('connection-status', `‚ùå Frontend Error: ${response.status}`, 'error');
                }
            } catch (error) {
                showStatus('connection-status', `‚ùå Error de frontend: ${error.message}`, 'error');
            }
        }

        // Test de todos los endpoints
        async function testAllEndpoints() {
            const endpoints = [
                '/usuarios/',
                '/tratamientos/',
                '/medicamentos/',
                '/auth/me'
            ];

            addLog('üîç Probando todos los endpoints...');
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${BASE_URL}${endpoint}`);
                    if (response.ok) {
                        addLog(`‚úÖ ${endpoint} - OK (${response.status})`);
                    } else {
                        addLog(`‚ùå ${endpoint} - Error ${response.status}`);
                    }
                } catch (error) {
                    addLog(`‚ùå ${endpoint} - ${error.message}`);
                }
            }
        }

        // Debug de login
        async function debugLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                addLog(`üîê Intentando login con: ${email}`);
                
                const response = await fetch(`${BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });

                const data = await response.json();
                addLog(`üìä Respuesta del login: ${JSON.stringify(data, null, 2)}`);

                if (response.ok) {
                    // Guardar en localStorage
                    localStorage.setItem('user_id', data.user_id);
                    localStorage.setItem('id', data.user_id);
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('user_data', JSON.stringify(data));
                    
                    currentUserId = data.user_id;
                    document.getElementById('user-id').value = data.user_id;
                    
                    showStatus('auth-status', `‚úÖ Login exitoso - Usuario ID: ${data.user_id}`, 'success');
                } else {
                    showStatus('auth-status', `‚ùå Error de login: ${data.detail || 'Error desconocido'}`, 'error');
                }
            } catch (error) {
                showStatus('auth-status', `‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        // Verificar localStorage
        function checkStoredAuth() {
            const userId = localStorage.getItem('user_id');
            const token = localStorage.getItem('access_token');
            const userData = localStorage.getItem('user_data');
            
            addLog('üîç Verificando localStorage...');
            addLog(`user_id: ${userId}`);
            addLog(`access_token: ${token ? 'presente' : 'no encontrado'}`);
            addLog(`user_data: ${userData ? 'presente' : 'no encontrado'}`);
            
            if (userId && token) {
                currentUserId = userId;
                document.getElementById('user-id').value = userId;
                showStatus('auth-status', `‚úÖ Sesi√≥n encontrada - Usuario ID: ${userId}`, 'success');
            } else {
                showStatus('auth-status', '‚ùå No hay sesi√≥n guardada', 'error');
            }
        }

        // Limpiar localStorage
        function clearLocalStorage() {
            localStorage.clear();
            currentUserId = null;
            addLog('üßπ localStorage limpiado');
            showStatus('auth-status', 'üßπ localStorage limpiado', 'info');
        }

        // Test de API de medicamentos
        async function testMedicamentosAPI() {
            const userId = document.getElementById('user-id').value;
            
            try {
                addLog(`üíä Probando API de medicamentos para usuario: ${userId}`);
                
                const response = await fetch(`${BASE_URL}/medicamentos/?usuario_id=${userId}`);
                const data = await response.json();
                
                addLog(`üìä Respuesta de medicamentos: ${JSON.stringify(data, null, 2)}`);
                
                if (response.ok) {
                    if (Array.isArray(data) && data.length > 0) {
                        addLog(`üìã Campos del primer medicamento: ${Object.keys(data[0]).join(', ')}`);
                        showStatus('medicamentos-status', `‚úÖ API OK - ${data.length} medicamentos encontrados`, 'success');
                    } else {
                        showStatus('medicamentos-status', '‚ö†Ô∏è API OK pero sin medicamentos', 'info');
                    }
                } else {
                    showStatus('medicamentos-status', `‚ùå Error API: ${response.status}`, 'error');
                }
            } catch (error) {
                showStatus('medicamentos-status', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Debug del frontend de medicamentos
        function debugMedicamentosFrontend() {
            addLog('üîç Debuggeando frontend de medicamentos...');
            
            // Verificar elementos DOM
            const medicamentosList = document.querySelector('.medication-list');
            addLog(`medication-list element: ${medicamentosList ? 'encontrado' : 'NO ENCONTRADO'}`);
            
            // Verificar variables globales
            addLog(`currentUserId: ${typeof currentUserId !== 'undefined' ? currentUserId : 'NO DEFINIDO'}`);
            addLog(`BASE_URL: ${typeof BASE_URL !== 'undefined' ? BASE_URL : 'NO DEFINIDO'}`);
            
            // Verificar funci√≥n cargarMedicamentos
            if (typeof cargarMedicamentos === 'function') {
                addLog('‚úÖ cargarMedicamentos function exists');
                addLog('üîÑ Ejecutando cargarMedicamentos()...');
                cargarMedicamentos();
            } else {
                addLog('‚ùå cargarMedicamentos function NOT FOUND');
            }
            
            showStatus('medicamentos-status', 'Debug frontend ejecutado - revisar logs', 'info');
        }

        // Crear medicamento de prueba
        async function createTestMedicamento() {
            const userId = document.getElementById('user-id').value;
            
            try {
                // Primero crear un tratamiento si no existe
                const tratamientoData = {
                    ID_USUARIO: parseInt(userId),
                    NOMBRE_TRATAMIENTO: "Tratamiento Debug",
                    FECHA_INICIO: "2024-01-01",
                    FECHA_FIN: "2024-12-31",
                    ESTADO: true
                };
                
                addLog('üè• Creando tratamiento de prueba...');
                const tratamientoResponse = await fetch(`${BASE_URL}/tratamientos/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(tratamientoData)
                });
                
                let tratamientoId;
                if (tratamientoResponse.ok) {
                    const tratamiento = await tratamientoResponse.json();
                    tratamientoId = tratamiento.ID_TRATAMIENTO;
                    addLog(`‚úÖ Tratamiento creado con ID: ${tratamientoId}`);
                } else {
                    // Si falla, buscar un tratamiento existente
                    const tratamientosResponse = await fetch(`${BASE_URL}/tratamientos/?usuario_id=${userId}`);
                    const tratamientos = await tratamientosResponse.json();
                    if (tratamientos.length > 0) {
                        tratamientoId = tratamientos[0].ID_TRATAMIENTO;
                        addLog(`üìã Usando tratamiento existente con ID: ${tratamientoId}`);
                    } else {
                        throw new Error('No se pudo crear o encontrar un tratamiento');
                    }
                }
                
                // Crear medicamento
                const medicamentoData = {
                    ID_TRATAMIENTO: tratamientoId,
                    NOMBRE: "Medicamento Debug",
                    DOSIS: "100mg",
                    HORA: "08:00",
                    OBSERVACION: "Medicamento de prueba",
                    INTERVALO: 8
                };
                
                addLog('üíä Creando medicamento de prueba...');
                const medicamentoResponse = await fetch(`${BASE_URL}/medicamentos/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(medicamentoData)
                });
                
                if (medicamentoResponse.ok) {
                    const medicamento = await medicamentoResponse.json();
                    addLog(`‚úÖ Medicamento creado: ${JSON.stringify(medicamento, null, 2)}`);
                    showStatus('medicamentos-status', '‚úÖ Medicamento de prueba creado exitosamente', 'success');
                } else {
                    const error = await medicamentoResponse.json();
                    addLog(`‚ùå Error creando medicamento: ${JSON.stringify(error, null, 2)}`);
                    showStatus('medicamentos-status', `‚ùå Error: ${error.detail}`, 'error');
                }
                
            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`);
                showStatus('medicamentos-status', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Test de API de tratamientos
        async function testTratamientosAPI() {
            const userId = document.getElementById('user-id').value;
            
            try {
                addLog(`üè• Probando API de tratamientos para usuario: ${userId}`);
                
                const response = await fetch(`${BASE_URL}/tratamientos/?usuario_id=${userId}`);
                const data = await response.json();
                
                addLog(`üìä Respuesta de tratamientos: ${JSON.stringify(data, null, 2)}`);
                
                if (response.ok) {
                    showStatus('tratamientos-status', `‚úÖ API OK - ${data.length} tratamientos encontrados`, 'success');
                } else {
                    showStatus('tratamientos-status', `‚ùå Error API: ${response.status}`, 'error');
                }
            } catch (error) {
                showStatus('tratamientos-status', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Crear tratamiento de prueba
        async function createTestTratamiento() {
            const userId = document.getElementById('user-id').value;
            
            const tratamientoData = {
                ID_USUARIO: parseInt(userId),
                NOMBRE_TRATAMIENTO: "Tratamiento Test " + Date.now(),
                FECHA_INICIO: "2024-01-01",
                FECHA_FIN: "2024-12-31",
                ESTADO: true
            };
            
            try {
                addLog('üè• Creando tratamiento de prueba...');
                
                const response = await fetch(`${BASE_URL}/tratamientos/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(tratamientoData)
                });
                
                const data = await response.json();
                addLog(`üìä Respuesta: ${JSON.stringify(data, null, 2)}`);
                
                if (response.ok) {
                    showStatus('tratamientos-status', `‚úÖ Tratamiento creado con ID: ${data.ID_TRATAMIENTO}`, 'success');
                } else {
                    showStatus('tratamientos-status', `‚ùå Error: ${data.detail}`, 'error');
                }
            } catch (error) {
                showStatus('tratamientos-status', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Verificar tablas de la base de datos
        async function checkDatabaseTables() {
            addLog('üóÑÔ∏è Verificando estructura de la base de datos...');
            
            const tables = ['usuarios', 'tratamientos', 'medicamentos'];
            
            for (const table of tables) {
                try {
                    const response = await fetch(`${BASE_URL}/${table}/`);
                    if (response.ok) {
                        const data = await response.json();
                        addLog(`‚úÖ Tabla ${table}: ${data.length} registros`);
                    } else {
                        addLog(`‚ùå Tabla ${table}: Error ${response.status}`);
                    }
                } catch (error) {
                    addLog(`‚ùå Tabla ${table}: ${error.message}`);
                }
            }
            
            showStatus('database-status', 'Verificaci√≥n de base de datos completada - revisar logs', 'info');
        }

        // Mostrar datos de la base de datos
        async function showDatabaseData() {
            addLog('üìä Mostrando datos de la base de datos...');
            
            try {
                // Usuarios
                const usuarios = await fetch(`${BASE_URL}/usuarios/`).then(r => r.json());
                addLog(`üë• USUARIOS (${usuarios.length}):`);
                usuarios.forEach((u, i) => addLog(`  ${i+1}. ID: ${u.ID_USUARIO}, Email: ${u.CORREO}, Nombre: ${u.NOMBRE}`));
                
                // Tratamientos
                const tratamientos = await fetch(`${BASE_URL}/tratamientos/`).then(r => r.json());
                addLog(`üè• TRATAMIENTOS (${tratamientos.length}):`);
                tratamientos.forEach((t, i) => addLog(`  ${i+1}. ID: ${t.ID_TRATAMIENTO}, Usuario: ${t.ID_USUARIO}, Nombre: ${t.NOMBRE_TRATAMIENTO}`));
                
                // Medicamentos
                const medicamentos = await fetch(`${BASE_URL}/medicamentos/`).then(r => r.json());
                addLog(`üíä MEDICAMENTOS (${medicamentos.length}):`);
                medicamentos.forEach((m, i) => addLog(`  ${i+1}. ID: ${m.ID_MEDICAMENTO}, Tratamiento: ${m.ID_TRATAMIENTO}, Nombre: ${m.NOMBRE}`));
                
                showStatus('database-status', 'Datos de base de datos mostrados - revisar logs', 'info');
            } catch (error) {
                addLog(`‚ùå Error mostrando datos: ${error.message}`);
                showStatus('database-status', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Limpiar logs
        function clearLogs() {
            document.getElementById('console-output').textContent = '';
            addLog('üßπ Logs limpiados');
        }

        // Habilitar logging detallado
        function enableVerboseLogging() {
            verboseLogging = !verboseLogging;
            addLog(`üîß Logging detallado: ${verboseLogging ? 'HABILITADO' : 'DESHABILITADO'}`);
        }

        // Inicializaci√≥n
        window.addEventListener('DOMContentLoaded', function() {
            addLog('üöÄ Panel de debug inicializado');
            addLog('‚ÑπÔ∏è Usa los botones para probar diferentes funcionalidades');
            
            // Verificar sesi√≥n existente
            checkStoredAuth();
        });

        // Capturar errores globales
        window.addEventListener('error', function(event) {
            addLog(`‚ùå Error global: ${event.error.message}`, 'error');
        });

        // Capturar errores de promesas
        window.addEventListener('unhandledrejection', function(event) {
            addLog(`‚ùå Promise rejections: ${event.reason}`, 'error');
        });
    </script>
</body>
</html>
