<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Debug Dashboard - TomaSalud</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="assets/css/dashboard.css">
    <style>
        .debug-panel {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 20px 0;
            border: 2px solid #ff6b35;
        }
        .debug-buttons {
            margin: 10px 0;
        }
        .debug-btn {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 12px;
        }
        .status-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            margin: 5px;
        }
        .status-ok { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <main class="dashboard-container">
        <header class="dashboard-header">
            <div class="logo-area">
                <img src="assets/images/logo.png" alt="Logo de TomaSalud" class="logo-image">
                <span class="logo-text">üîç TomaSalud Debug</span>
            </div>
            <div class="user-profile">
                <span class="username" id="username-display">Usuario Debug</span>
                <img src="assets/images/usuario.png" alt="Icono de usuario" class="user-icon">
            </div>
        </header>

        <!-- Panel de Debug -->
        <section style="padding: 20px; background: #f8f9fa;">
            <h2>üîç Panel de Debug - Medicamentos</h2>
            
            <div class="debug-buttons">
                <button class="debug-btn" onclick="debugAuth()">üîê Debug Auth</button>
                <button class="debug-btn" onclick="debugMedicamentos()">üíä Debug Medicamentos</button>
                <button class="debug-btn" onclick="hacerLogin()">üîì Hacer Login</button>
                <button class="debug-btn" onclick="cargarMedicamentosManual()">üì• Cargar Medicamentos</button>
                <button class="debug-btn" onclick="limpiarConsola()">üßπ Limpiar</button>
            </div>

            <div>
                <span>Estado Auth:</span><span id="auth-status" class="status-indicator status-warning">Verificando...</span>
                <span>Estado Medicamentos:</span><span id="med-status" class="status-indicator status-warning">Pendiente</span>
            </div>

            <div class="debug-panel" id="debug-console">
=== Debug Dashboard Medicamentos ===
P√°gina cargada - Iniciando diagn√≥stico...
            </div>
        </section>

        <section class="dashboard-content">
            <!-- Panel de Medicamentos con Debug -->
            <div class="medications-panel">
                <div class="medications-panel-header">
                    <h3 class="panel-title">üíä Medicamentos (Debug)</h3>
                    <div class="medications-header-buttons">
                        <button class="action-button edit-button-medications">Editar</button>
                        <button class="action-button delete-button-medications">Eliminar</button>
                    </div>
                </div>
                <ul class="medication-list" id="medication-list">
                    <li style="color: #666; text-align: center; padding: 20px;">
                        üîç Debug Mode - Medicamentos aparecer√°n aqu√≠
                    </li>
                </ul>
                <div class="panel-footer">
                    <button class="add-button" id="add-medication-button">+ Nuevo Medicamento</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Scripts -->
    <script src="assets/js/config.js"></script>
    <script>
        const BASE_URL = 'http://127.0.0.1:8000';
        let currentUserId = null;
        let medicamentoSeleccionado = null;

        function debugLog(message) {
            const console = document.getElementById('debug-console');
            const timestamp = new Date().toLocaleTimeString();
            console.textContent += `\n[${timestamp}] ${message}`;
            console.scrollTop = console.scrollHeight;
            window.console.log(`[DEBUG] ${message}`);
        }

        function updateStatus(elementId, text, type = 'warning') {
            const element = document.getElementById(elementId);
            element.textContent = text;
            element.className = `status-indicator status-${type}`;
        }

        function limpiarConsola() {
            document.getElementById('debug-console').textContent = '=== Debug Dashboard Medicamentos ===\nConsola limpiada...';
        }

        async function debugAuth() {
            debugLog('üîê === DEBUG AUTENTICACI√ìN ===');
            
            // Verificar localStorage
            const userData = localStorage.getItem('user_data');
            const userId = localStorage.getItem('user_id');
            const id = localStorage.getItem('id');
            
            debugLog(`üì¶ localStorage.user_data: ${userData ? 'EXISTS' : 'NULL'}`);
            debugLog(`üì¶ localStorage.user_id: ${userId ? userId : 'NULL'}`);
            debugLog(`üì¶ localStorage.id: ${id ? id : 'NULL'}`);
            
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    debugLog(`‚úÖ user_data parseado: ${JSON.stringify(user, null, 2)}`);
                    currentUserId = user.user_id || user.id;
                } catch (e) {
                    debugLog(`‚ùå Error parseando user_data: ${e.message}`);
                }
            }
            
            if (userId) {
                currentUserId = userId;
                debugLog(`‚úÖ Usuario desde user_id: ${currentUserId}`);
            }
            
            debugLog(`üéØ currentUserId final: ${currentUserId}`);
            
            if (currentUserId) {
                updateStatus('auth-status', `Autenticado: ${currentUserId}`, 'ok');
            } else {
                updateStatus('auth-status', 'No autenticado', 'error');
            }
        }

        async function hacerLogin() {
            try {
                debugLog('üîê Haciendo login...');
                updateStatus('auth-status', 'Haciendo login...', 'warning');
                
                const response = await fetch(`${BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'freligio008@gmail.com',
                        password: '123456'
                    })
                });

                const data = await response.json();
                debugLog(`üìä Respuesta login: ${JSON.stringify(data, null, 2)}`);
                
                if (response.ok) {
                    currentUserId = data.user_id;
                    localStorage.setItem('user_id', data.user_id);
                    localStorage.setItem('user_data', JSON.stringify(data));
                    
                    updateStatus('auth-status', `Login OK: ${data.user_id}`, 'ok');
                    debugLog(`‚úÖ Login exitoso - Usuario ID: ${data.user_id}`);
                    
                    // Auto-cargar medicamentos despu√©s del login
                    setTimeout(() => cargarMedicamentosManual(), 1000);
                } else {
                    updateStatus('auth-status', `Error: ${data.detail}`, 'error');
                    debugLog(`‚ùå Error login: ${data.detail}`);
                }
            } catch (error) {
                updateStatus('auth-status', `Error: ${error.message}`, 'error');
                debugLog(`‚ùå Error login: ${error.message}`);
            }
        }

        async function debugMedicamentos() {
            debugLog('üíä === DEBUG MEDICAMENTOS ===');
            
            // Verificar elementos DOM
            const medicamentosList = document.querySelector('.medication-list');
            debugLog(`üìã Elemento .medication-list: ${medicamentosList ? 'ENCONTRADO' : 'NO ENCONTRADO'}`);
            
            if (medicamentosList) {
                debugLog(`üìã ID del elemento: ${medicamentosList.id}`);
                debugLog(`üìã Clases: ${medicamentosList.className}`);
                debugLog(`üìã Contenido actual: ${medicamentosList.innerHTML.substring(0, 100)}...`);
            }
            
            // Verificar usuario
            debugLog(`üë§ currentUserId: ${currentUserId}`);
            
            if (!currentUserId) {
                debugLog('‚ùå No hay usuario - ejecutando debugAuth...');
                await debugAuth();
            }
        }

        async function cargarMedicamentosManual() {
            if (!currentUserId) {
                debugLog('‚ùå No hay usuario logueado');
                updateStatus('med-status', 'Sin usuario', 'error');
                return;
            }

            try {
                debugLog(`üíä Cargando medicamentos para usuario: ${currentUserId}`);
                updateStatus('med-status', 'Cargando...', 'warning');
                
                const url = `${BASE_URL}/medicamentos/?usuario_id=${currentUserId}`;
                debugLog(`üåê URL: ${url}`);
                
                const response = await fetch(url);
                debugLog(`üì° Response status: ${response.status}`);
                debugLog(`üì° Response ok: ${response.ok}`);
                
                const medicamentos = await response.json();
                debugLog(`üíä Medicamentos recibidos: ${JSON.stringify(medicamentos, null, 2)}`);
                
                const medicamentosList = document.getElementById('medication-list');
                if (!medicamentosList) {
                    debugLog('‚ùå No se encontr√≥ #medication-list');
                    return;
                }
                
                debugLog('üßπ Limpiando lista...');
                medicamentosList.innerHTML = '';

                if (Array.isArray(medicamentos) && medicamentos.length > 0) {
                    debugLog(`‚úÖ Procesando ${medicamentos.length} medicamentos...`);
                    
                    medicamentos.forEach((medicamento, index) => {
                        debugLog(`üíä Creando elemento ${index + 1}: ${medicamento.NOMBRE}`);
                        
                        const li = document.createElement('li');
                        li.className = 'medication-item';
                        li.dataset.medicamentoId = medicamento.ID_MEDICAMENTO;
                        li.innerHTML = `
                            <div class="medication-info">
                                <strong>${medicamento.NOMBRE || 'Sin nombre'}</strong>
                                <div class="medication-details">
                                    <span>Dosis: ${medicamento.DOSIS || 'Sin dosis'}</span>
                                    <span>Hora: ${medicamento.HORA || 'Sin hora'}</span>
                                    <span>ID: ${medicamento.ID_MEDICAMENTO}</span>
                                </div>
                            </div>
                        `;
                        
                        // Event listener con debug
                        li.addEventListener('click', function() {
                            debugLog(`üéØ CLICK en medicamento: ${medicamento.NOMBRE} (ID: ${medicamento.ID_MEDICAMENTO})`);
                            
                            // Limpiar selecciones
                            document.querySelectorAll('.medication-item').forEach(item => {
                                item.classList.remove('selected');
                            });
                            
                            // Seleccionar actual
                            li.classList.add('selected');
                            medicamentoSeleccionado = medicamento;
                            
                            debugLog(`‚úÖ Medicamento seleccionado: ${medicamento.NOMBRE}`);
                        });
                        
                        medicamentosList.appendChild(li);
                        debugLog(`‚úÖ Elemento ${index + 1} agregado al DOM`);
                    });
                    
                    updateStatus('med-status', `${medicamentos.length} medicamentos cargados`, 'ok');
                    debugLog(`üéâ ${medicamentos.length} medicamentos cargados exitosamente`);
                } else {
                    medicamentosList.innerHTML = '<li style="color: #666; text-align: center; padding: 20px;">No hay medicamentos registrados</li>';
                    updateStatus('med-status', 'Sin medicamentos', 'warning');
                    debugLog('‚ö†Ô∏è No hay medicamentos para mostrar');
                }
            } catch (error) {
                debugLog(`‚ùå Error cargando medicamentos: ${error.message}`);
                updateStatus('med-status', `Error: ${error.message}`, 'error');
            }
        }

        // Auto-ejecutar al cargar la p√°gina
        window.addEventListener('load', async () => {
            debugLog('üì± P√°gina cargada');
            await debugAuth();
            
            if (currentUserId) {
                debugLog('üöÄ Usuario detectado, cargando medicamentos...');
                setTimeout(() => cargarMedicamentosManual(), 1000);
            } else {
                debugLog('‚ö†Ô∏è No hay usuario, necesitas hacer login');
            }
        });
    </script>
</body>
</html>