<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Medicamentos - TomaSalud</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        .medication-list {
            list-style: none;
            padding: 0;
        }
        .medication-item {
            background: #f9f9f9;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        .medication-info strong {
            display: block;
            font-size: 16px;
            color: #333;
            margin-bottom: 5px;
        }
        .medication-details {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>üß™ Test de Medicamentos - TomaSalud</h1>

    <div class="test-section">
        <h2>üîê Autenticaci√≥n</h2>
        <button onclick="testLogin()">1. Login</button>
        <button onclick="checkAuth()">2. Verificar Auth</button>
        <div id="auth-status"></div>
    </div>

    <div class="test-section">
        <h2>üíä Test de Medicamentos</h2>
        <button onclick="testMedicamentosAPI()">3. Probar API</button>
        <button onclick="loadMedicamentosUI()">4. Cargar en UI</button>
        <button onclick="createTestMedicamento()">5. Crear Medicamento</button>
        <div id="medicamentos-status"></div>
        
        <h3>Lista de Medicamentos:</h3>
        <ul class="medication-list" id="medication-list"></ul>
    </div>

    <div class="test-section">
        <h2>üîç Console Log</h2>
        <button onclick="clearLog()">Limpiar Log</button>
        <div id="console-log" class="log"></div>
    </div>

    <script>
        const BASE_URL = 'http://127.0.0.1:8000';
        let currentUserId = null;

        function log(message) {
            const logElement = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('console-log').textContent = '';
        }

        function showStatus(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div style="color: ${isError ? 'red' : 'green'}; padding: 10px; background: ${isError ? '#fee' : '#efe'}; border-radius: 5px; margin: 10px 0;">${message}</div>`;
        }

        async function testLogin() {
            try {
                log('üîê Iniciando login...');
                
                const response = await fetch(`${BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'freligio008@gmail.com',
                        password: '123456'
                    })
                });

                const data = await response.json();
                log(`üìä Respuesta del login: ${JSON.stringify(data, null, 2)}`);

                if (response.ok) {
                    localStorage.setItem('user_id', data.user_id);
                    localStorage.setItem('id', data.user_id);
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('user_data', JSON.stringify(data));
                    
                    currentUserId = data.user_id;
                    
                    showStatus('auth-status', `‚úÖ Login exitoso - Usuario ID: ${data.user_id}`);
                    log(`‚úÖ Login exitoso, usuario ID: ${data.user_id}`);
                } else {
                    showStatus('auth-status', `‚ùå Error de login: ${data.detail || 'Error desconocido'}`, true);
                    log(`‚ùå Error de login: ${data.detail}`);
                }
            } catch (error) {
                showStatus('auth-status', `‚ùå Error de conexi√≥n: ${error.message}`, true);
                log(`‚ùå Error: ${error.message}`);
            }
        }

        function checkAuth() {
            const userId = localStorage.getItem('user_id');
            const token = localStorage.getItem('access_token');
            
            log('üîç Verificando localStorage...');
            log(`user_id: ${userId}`);
            log(`access_token: ${token ? 'presente' : 'no encontrado'}`);
            
            if (userId && token) {
                currentUserId = userId;
                showStatus('auth-status', `‚úÖ Sesi√≥n encontrada - Usuario ID: ${userId}`);
                log(`‚úÖ Sesi√≥n v√°lida encontrada`);
            } else {
                showStatus('auth-status', '‚ùå No hay sesi√≥n guardada', true);
                log('‚ùå No hay sesi√≥n guardada');
            }
        }

        async function testMedicamentosAPI() {
            if (!currentUserId) {
                showStatus('medicamentos-status', '‚ùå Debes hacer login primero', true);
                return;
            }

            try {
                log(`üíä Probando API de medicamentos para usuario: ${currentUserId}`);
                
                const response = await fetch(`${BASE_URL}/medicamentos/?usuario_id=${currentUserId}`);
                const data = await response.json();
                
                log(`üìä Respuesta de medicamentos: ${JSON.stringify(data, null, 2)}`);
                
                if (response.ok) {
                    if (Array.isArray(data) && data.length > 0) {
                        log(`üìã Campos del primer medicamento: ${Object.keys(data[0]).join(', ')}`);
                        showStatus('medicamentos-status', `‚úÖ API OK - ${data.length} medicamentos encontrados`);
                    } else {
                        showStatus('medicamentos-status', '‚ö†Ô∏è API OK pero sin medicamentos');
                    }
                } else {
                    showStatus('medicamentos-status', `‚ùå Error API: ${response.status}`, true);
                }
            } catch (error) {
                showStatus('medicamentos-status', `‚ùå Error: ${error.message}`, true);
                log(`‚ùå Error: ${error.message}`);
            }
        }

        async function loadMedicamentosUI() {
            if (!currentUserId) {
                showStatus('medicamentos-status', '‚ùå Debes hacer login primero', true);
                return;
            }

            try {
                log(`üíä Cargando medicamentos en UI para usuario: ${currentUserId}`);
                
                const medicamentosList = document.getElementById('medication-list');
                medicamentosList.innerHTML = '';

                const response = await fetch(`${BASE_URL}/medicamentos/?usuario_id=${currentUserId}`);
                const medicamentos = await response.json();
                
                log(`üíä Medicamentos recibidos: ${medicamentos.length}`);

                if (Array.isArray(medicamentos) && medicamentos.length > 0) {
                    medicamentos.forEach((medicamento, index) => {
                        log(`üíä Procesando medicamento ${index + 1}: ${medicamento.NOMBRE}`);
                        
                        const li = document.createElement('li');
                        li.className = 'medication-item';
                        li.innerHTML = `
                            <div class="medication-info">
                                <strong>${medicamento.NOMBRE || 'Sin nombre'}</strong>
                                <div class="medication-details">
                                    <span>Dosis: ${medicamento.DOSIS || 'Sin dosis'}</span>
                                    <span>Hora: ${medicamento.HORA || 'Sin hora'}</span>
                                    <span>Observaci√≥n: ${medicamento.OBSERVACION || 'Sin observaci√≥n'}</span>
                                </div>
                            </div>
                        `;
                        
                        medicamentosList.appendChild(li);
                    });
                    
                    showStatus('medicamentos-status', `‚úÖ ${medicamentos.length} medicamentos cargados en UI`);
                    log(`‚úÖ ${medicamentos.length} medicamentos mostrados en la UI`);
                } else {
                    medicamentosList.innerHTML = '<li style="color: #666; text-align: center; padding: 20px;">No hay medicamentos registrados</li>';
                    showStatus('medicamentos-status', '‚ö†Ô∏è No hay medicamentos para mostrar');
                    log('‚ö†Ô∏è No hay medicamentos para mostrar');
                }
            } catch (error) {
                showStatus('medicamentos-status', `‚ùå Error cargando UI: ${error.message}`, true);
                log(`‚ùå Error cargando UI: ${error.message}`);
            }
        }

        async function createTestMedicamento() {
            if (!currentUserId) {
                showStatus('medicamentos-status', '‚ùå Debes hacer login primero', true);
                return;
            }

            try {
                log('üè• Creando tratamiento de prueba...');
                
                // Crear tratamiento
                const tratamientoData = {
                    ID_USUARIO: parseInt(currentUserId),
                    NOMBRE_TRATAMIENTO: "Tratamiento Test " + Date.now(),
                    FECHA_INICIO: "2024-01-01",
                    FECHA_FIN: "2024-12-31",
                    ESTADO: true
                };
                
                const tratamientoResponse = await fetch(`${BASE_URL}/tratamientos/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(tratamientoData)
                });
                
                let tratamientoId;
                if (tratamientoResponse.ok) {
                    const tratamiento = await tratamientoResponse.json();
                    tratamientoId = tratamiento.ID_TRATAMIENTO;
                    log(`‚úÖ Tratamiento creado con ID: ${tratamientoId}`);
                } else {
                    // Buscar tratamiento existente
                    const tratamientosResponse = await fetch(`${BASE_URL}/tratamientos/?usuario_id=${currentUserId}`);
                    const tratamientos = await tratamientosResponse.json();
                    if (tratamientos.length > 0) {
                        tratamientoId = tratamientos[0].ID_TRATAMIENTO;
                        log(`üìã Usando tratamiento existente con ID: ${tratamientoId}`);
                    } else {
                        throw new Error('No se pudo crear o encontrar un tratamiento');
                    }
                }
                
                // Crear medicamento
                const medicamentoData = {
                    ID_TRATAMIENTO: tratamientoId,
                    NOMBRE: "Medicamento Test " + Date.now(),
                    DOSIS: "100mg",
                    HORA: "08:00",
                    OBSERVACION: "Medicamento de prueba",
                    INTERVALO: 8
                };
                
                log('üíä Creando medicamento de prueba...');
                const medicamentoResponse = await fetch(`${BASE_URL}/medicamentos/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(medicamentoData)
                });
                
                if (medicamentoResponse.ok) {
                    const medicamento = await medicamentoResponse.json();
                    log(`‚úÖ Medicamento creado: ${JSON.stringify(medicamento, null, 2)}`);
                    showStatus('medicamentos-status', '‚úÖ Medicamento de prueba creado exitosamente');
                    
                    // Recargar la UI autom√°ticamente
                    setTimeout(() => {
                        loadMedicamentosUI();
                    }, 1000);
                } else {
                    const error = await medicamentoResponse.json();
                    log(`‚ùå Error creando medicamento: ${JSON.stringify(error, null, 2)}`);
                    showStatus('medicamentos-status', `‚ùå Error: ${error.detail}`, true);
                }
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                showStatus('medicamentos-status', `‚ùå Error: ${error.message}`, true);
            }
        }

        // Inicializaci√≥n
        window.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Test de medicamentos inicializado');
            
            // Verificar si hay sesi√≥n existente
            checkAuth();
        });
    </script>
</body>
</html>